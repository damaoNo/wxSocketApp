<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no" />
    <title>获取设备摄像头 getUserMedia</title>
    <!--[if lt IE 9]><script>alert('您的浏览器版本过低，请更新本版本浏览器，或更换为诸如谷歌浏览器的现代浏览器')</script><![endif]-->
    <style>
        .bg {
            display: block;
            width: 100%;
            background: #000;
        }
        #out{
            height: 400px;
            overflow: auto;
        }
        #out p{
            margin: 0;
            font-size: 12px;
        }
    </style>
</head>

<body>
<button id="play">切换播放</button>
<button id="luzhi">录制</button>
<button id="jieshu">结束</button>
<video class="bg"></video>
<div id="out"></div>
<script>
    window.onerror = function (e, url, line) {
        alert(`${e}\n${url}\n{line}`)
    };
    // 一堆兼容代码
    window.URL = (window.URL || window.webkitURL || window.mozURL || window.msURL);
    if (navigator.mediaDevices === undefined) {
        navigator.mediaDevices = {};
    }
    if (navigator.mediaDevices.getUserMedia === undefined) {
        navigator.mediaDevices.getUserMedia = function(constraints) {
            var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
            if (!getUserMedia) {
                return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
            }
            return new Promise(function(resolve, reject) {
                getUserMedia.call(navigator, constraints, resolve, reject);
            });
        }
    }

    // 配置设置
    var mediaOpts = {
        audio: false,
        video: true,
        // video: { width: 1280, height: 720 }
        // video: { facingMode: "environment"}, // 或者 "user"
    }
    var video = document.querySelector('video');
    // 成功回调
    function successFunc(stream) {
        if ("srcObject" in video) {
            video.srcObject = stream
        } else {
            video.src = window.URL && window.URL.createObjectURL(stream) || stream
        }
        video.pause();
    }
    function errorFunc(err) {
        alert(err.name);
    }

    var _token_ = 'rdsa213132131dfsaf';
    var url = 'wss://www.nodejser.site/?token=' + _token_;
    var _webSocket_ = new WebSocket(url);
    _webSocket_.onopen = function() {
        print('socket已连接');
    };
    _webSocket_.onmessage = function (data) {
        var res = JSON.parse(data.data);
        if(res.action === 'apply format'){
            print('服务端接受格式：' + res.suffix);
            _suffix_ = res.sufiix;
        }
        if(res.action === 'saved success'){
            print('视频保存路径:' + res.path);
        }
        if(res.action === 'saved failed'){
            print(res.errorMessage);
        }
    };
    _webSocket_.onerror = function(e) {
        alert('socket连接出错');
        alert(e);
    };
    _webSocket_.onclose = function() {
        alert('socket已关闭');
    };

    let isPlay = false;
    let mediaRecorder;
    document.getElementById('play').onclick = function () {
        if(isPlay){
            video.pause();
        }else{
            video.play();
        }
        isPlay = !isPlay;
    };
    document.getElementById('luzhi').onclick = function () {
        _webSocket_.send(JSON.stringify({action: 'record start', token: _token_}));
        var options = {
            mimeType: 'video/webm',
            audioBitsPerSecond : 128000,
            videoBitsPerSecond : 256000
        };
        recordedBlobs = [];
        try {
            mediaRecorder = new MediaRecorder(window.stream, options);
        } catch (e0) {
            print('Unable to create MediaRecorder with options Object: ', e0);
            try {
                options = {mimeType: 'video/webm,codecs=vp9', bitsPerSecond: 1000000};
                mediaRecorder = new MediaRecorder(window.stream, options);
            } catch (e1) {
                print('Unable to create MediaRecorder with options Object: ', e1);
                try {
                    options = 'video/vp8'; // Chrome 47
                    mediaRecorder = new MediaRecorder(window.stream, options);
                } catch (e2) {
                    alert('MediaRecorder is not supported by this browser.\n\n' +
                            'Try Firefox 29 or later, or Chrome 47 or later, with Enable experimental Web Platform features enabled from chrome://flags.');
                    print('Exception while creating MediaRecorder:', e2);
                    return;
                }
            }
        }
        mediaRecorder.onstop = function handleStop(event) {
            console.log('Recorder stopped: ', event);
        };
        mediaRecorder.ondataavailable = function handleDataAvailable(event) {
            if (event.data && event.data.size > 0) {
                _webSocket_.send(event.data);
            }
        };
        mediaRecorder.start(100); // collect 10ms of data
        print('MediaRecorder started');
    };
    document.getElementById('jieshu').onclick = function () {
        mediaRecorder.stop();
    };

    // 正式启动摄像头
    navigator.mediaDevices.getUserMedia(mediaOpts).then(successFunc).catch(errorFunc);

    var $out = document.getElementById('out');
    function print(msg) {
        var p = document.createElement('p');
        p.innerHTML = msg;
        $out.appendChild(p);
    }
</script>
</body>
</html>